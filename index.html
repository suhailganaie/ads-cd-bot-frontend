<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
    />
    <title>ADS BOT</title>

    <!-- Telegram Mini Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Early viewport bootstrap for Telegram webview -->
    <script>
      (function () {
        try {
          // Provide stable CSS vars for layout before app styles mount.
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg) {
            // Bind safe CSS tokens on load and react to viewport updates.
            const apply = () => {
              const h = tg.viewportStableHeight || tg.viewportHeight || 0;
              document.documentElement.style.setProperty('--tg-viewport-stable-height', h ? (h + 'px') : '100vh');
            };
            tg.onEvent?.('viewportChanged', apply);
            apply();

            // Signal readiness and try expanding when possible.
            tg.ready?.();
            tg.expand?.();
          }
        } catch {}
      })();
    </script>

    <!-- Ad SDKs (deferred) -->
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <script defer src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    <script defer src="//libtl.com/sdk.js" data-zone="9822309" data-sdk="show_9822309"></script>

    <!-- Unified ad helper + anti-overlap queue -->
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        try {
          const tg = window?.Telegram?.WebApp;
          tg?.ready?.();
          tg?.expand?.();
        } catch {}

        const queue = [];
        let showing = false;
        const next = () => {
          if (showing) return;
          const job = queue.shift();
          if (!job) return;
          showing = true;
          Promise.resolve(job())
            .catch(() => {})
            .finally(() => {
              showing = false;
              setTimeout(next, 1200);
            });
        };

        function showAdexium(opts) {
          return new Promise((resolve) => {
            try {
              if (!window.AdexiumWidget) return resolve();
              const adx = new window.AdexiumWidget({
                wid: opts.wid,
                adFormat: opts.format || 'interstitial',
              });

              const onRecv = (ad) => adx.displayAd(ad);
              const onDone = () => {
                adx.off?.('adReceived', onRecv);
                adx.off?.('adPlaybackCompleted', onDone);
                resolve('done');
              };
              const onNo = () => {
                adx.off?.('noAdFound', onNo);
                resolve('noAd');
              };

              adx.on?.('adReceived', onRecv);
              adx.on?.('adPlaybackCompleted', onDone);
              adx.on?.('noAdFound', onNo);
              adx.requestAd?.(opts.format || 'interstitial');
            } catch { resolve(); }
          });
        }

        function showMontage() {
          return new Promise((resolve) => {
            try {
              const fn = window?.show_9822309;
              if (typeof fn === 'function') {
                const p = fn({
                  type: 'inApp',
                  inAppSettings: { frequency: 1, capping: 1, interval: 3600, timeout: 50, everyPage: false },
                });
                if (p?.then) p.then(() => resolve('done')).catch(() => resolve());
                else resolve('done');
              } else resolve();
            } catch { resolve(); }
          });
        }

        window.ads = {
          show(provider, opts = {}) {
            queue.push(() => {
              if (provider === 'adexium') return showAdexium(opts);
              if (provider === 'montage') return showMontage();
              return Promise.resolve();
            });
            next();
          },
        };
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="src/index.jsx"></script>
  </body>
</html>
